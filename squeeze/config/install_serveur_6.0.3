#---------------------------------------------------------
' Installation des différents services complémentaires'
#---------------------------------------------------------

1 - Vérifier si les cartes réseaux correspondent bien dans les règles persistantes
2 - Configurer le réseau dans /etc/network/interfaces
3 - Installer le parefeu
4 - Configurer l'encapsuleur TCP (ssh et nfs)
5 - Synchroniser NTP
6 - Installer le serveur dhcp
7 - Installer apt-cacher (cache de paquet sur un réseau local)
8 - Installer le serveur DNS local et configurer dhcp
9 - Installer le cache squid
10- Filtrer squid avec squidGuard

Note :
Pour changer le nom d'un serveur :
# vim /etc/hostname
Il doit uniquement contenir le nom, ex :
cerbere

Puis
# vim /etc/hosts
127.0.0.1       localhost.localdomain localhost
192.168.2.1     cerbere.labo.arles cerbere

Pour valider le changement
# /etc/init.d/hostname.sh start

#-----------------------------------------
' Dans quel réseau ? '
#-----------------------------------------

Internet
1 Freebox V5 - IP 192.168.0.254
1 postet de travail windows/debian en sortie de la box - IP 192.168.0.6
1 Serveur sous debian Squeeze avec deux interfaces réseau eth0 et eth1
- eth0 : 192.168.0.253
        /-----/
-------/     /-------
      /_____/ 
- eth1 : 192.168.1.1
1 switch 5 ports
2 postes de travail Debian
	192.168.1.2
	192.168.1.3


#-------------------------------------------------------------------------------------
' 1 - Vérifier si les cartes réseaux correspondent bien dans les règles persistantes '
#-------------------------------------------------------------------------------------

Tout d'abord lancer une commande pour connaitre les caractéristiques des cartes réseau
# lspci | grep -i eth
02:00.0 Ethernet controller: Broadcom Corporation NetXtreme BCM5751 Gigabit Ethernet PCI Express (rev 01)
04:02.0 Ethernet controller: D-Link System Inc RTL8139 Ethernet (rev 10)

On part du principe que la carte supplémentaire a été ajouté manuellement et que donc on sait de laquelle il s'agit.

# ifconfig -a

Pour voir quelle adresse MAC correspond à quelle interface (eth0 - eth1)
Noter les adresses Mac.

Ouvrir le fichier /etc/udev/rules.d/70-persistent-net.rules
# This file was automatically generated by the /lib/udev/write_net_rules
# program, run by the persistent-net-generator.rules rules file.
#
# You can modify it, as long as you keep each rule on a single
# line, and change only the value of the NAME= key.

# PCI device 0x1186:0x1300 (8139too)
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="00:1b:11:6d:66:85", ATTR{dev_id}=="0x0", ATTR{type}=="1", KERNEL=="eth*", NAME="eth1"

# PCI device 0x14e4:0x1677 (tg3)
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="00:13:72:94:3b:77", ATTR{dev_id}=="0x0", ATTR{type}=="1", KERNEL=="eth*", NAME="eth0"

Au départ les adresses étaient inversées. Il a fallu adapter l'option NAME=

#-------------------------------------------------------------------------------------
' 2 - Configurer le réseau dans /etc/network/interfaces  '
#-------------------------------------------------------------------------------------

# vim /etc/network/interfaces
Le configurer comme ceci :

# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# lo 
auto lo
iface lo inet loopback

# Connection automatique
allow-hotplug eth1 eth0

# eth0 (entrée web)
auto eth0
iface eth0 inet static
        
        # freebox maison
	address 192.168.0.253
	netmask 255.255.255.0
        gateway 192.168.0.254

	# autre exemple : cas deuxième serveur dhcp.
	# address 192.168.1.99
	# netmask 255.255.255.0
	# gateway 192.168.1.1
	
	# Pour serveur Jacques à la Régie
        # address 192.168.0.99
        # netmask 255.255.255.0
        # gateway 192.168.0.2

# eth1 (réseau local)
auto eth1
iface eth1 inet static
        # freebox maison
        address 192.168.1.1
        netmask 255.255.255.0
       
	# autre exemple : cas deuxième serveur dhcp.
	# address 192.168.2.1
        # netmask 255.255.255.0

	# Pour serveur Jacques à la Régie
        # address 192.168.1.1
        # netmask 255.255.255.0

	
-----------------------
# service networking stop
# service networking start

#-------------------------------------------------------------------------------------
' 3 - Installer le parefeu '
#-------------------------------------------------------------------------------------

Mise en place du firewall dans :

# /etc/default/firewall

# /etc/firewall/firewall-stop
#========================================
# chmod 0700 /etc/firewall/firewall-stop
#========================================

# /etc/firewall/firewall-start
#========================================
# chmod 0700 /etc/firewall/firewall-start
#========================================

# /etc/init.d/firewall
#===============================
#chmod 0755 /etc/init.d/firewall
#===============================

# insserv firewall
# # sysv-rc-conf --list firewall
firewall     2:on	3:on	4:on	5:on
# sysv-rc-conf firewall on|off
# service firewall start|stop|status|restart


#-------------------------------------------------------------------------------------
' 4 - Configurer l'encapsuleur TCP '(ssh et nfs) '
#-------------------------------------------------------------------------------------

# vim /etc/hosts.allow
Le configurer comme ceci :

# /etc/hosts.allow 

ALL     :  localhost cerbere cerbere.labo.arles             : ALLOW
sshd    :  ALL                                              : ALLOW
portmap :  192.168.1.0/255.255.255.0 *.labo.arles           : ALLOW
mountd  :  192.168.1.0/255.255.255.0 *.labo.arles           : ALLOW

#-------------------------------------------------------------------------------------
' 5 - Synchroniser NTP '
#-------------------------------------------------------------------------------------

Ouvrir le port 123 en udp dans le parefeu
Arrêter le service :
# service ntp stop

Ajustement initial
# ntpdate fr.pool.ntp.org

Syncroniser le serveur local avec le serveur ntp
Créer le fichier journal :
# touch /var/log/ntp.log
# chown ntp:ntp /var/log/ntp.log

Éventuellement, aller sur http://www.pool.ntp.org et choisir la liste des serveurs en fonction du pays.

# service ntp start

Afficher la liste des serveurs auxquels on est connecté :
Sur le serveur le résultat sera le suivant
# ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
+asgard.syari.ne 193.190.230.65   2 u  350 1024  377   37.939    1.454   0.716
*ns1.adnscom.net 192.93.2.20      2 u  532 1024  377   34.267    0.269   0.679
+pixel.deuza.net 145.238.203.14   2 u  841 1024  377   34.132    0.481   1.449
+ntp.univ-poitie 129.70.132.33    3 u  415 1024  373   46.556    0.604   0.636
 LOCAL(0)        .LOCL.          10 l  10d   64    0    0.000    0.000   0.000

Le petit astérisque * en début de ligne signifie que la machine est correctement synchronisée
avec le serveur distant. La première synchronisation peut nécessiter quelques minutes,
parfois même une demi-heure.

Sur les clients le résultat sera le suivant
# ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*cerbere         88.191.90.195    3 u   19  128  377    0.184   -0.077   0.009
 LOCAL(0)        .LOCL.          10 l  78m   64    0    0.000    0.000   0.000

#-------------------------------------------------------------------------------------
' 6 - Installer le serveur dhcp '
#-------------------------------------------------------------------------------------

Pare-feu : ouvrir le port 67 en UDP.

# aptitude install dhcp3-server

# /etc/default/isc-dhcp-server
INTERFACES="eth1"

# /etc/dhcp/dhcpd.conf

L’option authoritative indique qu’il s’agit du serveur DHCP « officiel » du réseau local.
• Les options default-lease-time et max-lease-time définissent la période de validité des
  adresses IP. Dans l’exemple, c’est un jour, c’est-à-dire 86.400 secondes. Passé ce délai, les
  clients devront envoyer une nouvelle requête pour leurs paramètres, ce qui se fait automatiquement.
• Les options broadcast-address et subnet-mask décrivent le segment de réseau auquel le
  serveur DHCP fournit des données.
• L’option routers indique l’adresse de la machine devant servir de passerelle pour le réseau local.
• L’option domain-name-servers fournit une liste de serveurs DNS. Il peut y en avoir trois au
  maximum, séparés par des virgules. Ces adresses seront transmises aux postes clients.
• L’option domain-name fournit le nom de domaine, qui sera écrit dans le fichier
  /etc/resolv.conf du client, à la ligne search.
Si l’on utilise les DNS du FAI, la ligne correspondante ressemblera à ceci :
option domain-name-servers 62.4.16.70, 62.4.17.69;

Démarrer et arrêter le service :
# service isc-dhcp-server start|stop|restart|status
Activer/désactiver DHCP au démarrage du serveur :
# sysv-rc-conf isc-dhcp-server on|off

#-------------------------------------------------------------------------------------
' 7 - Installer apt-cacher (cache de paquet sur un réseau local) '
#-------------------------------------------------------------------------------------

ATTENTION : NE PAS CONNECTER DES MACHINES CLIENTES SUR LESQUELLES SONT INSTALLES
DIFFÉRENTES DISTRIBUTION : UN CACHE = UNE VERSION DE DISTRIBUTION

Pare-feu : ouvrir le port 3142 en TCP.

# aptitude install apt-cacher

Définir le démarrage automatique du service :
# /etc/default/apt-cacher
AUTOSTART=1

# /etc/apt-cacher/apt-cacher.conf
# /etc/apt-cacher/apt-cacher.conf

cache_dir=/var/cache/apt-cacher
admin_email=root@localhost
daemon_port=3142
# ---> Modification faite par JPA 
daemon_addr=192.168.1.1

group=www-data
user=www-data
# ---> Modification faite par JPA 
allowed_hosts=192.168.1.0/24

denied_hosts=
allowed_hosts_6=fec0::/16
denied_hosts_6=
generate_reports=1
clean_cache=1
offline_mode=0
logdir=/var/log/apt-cacher
expire_hours=0
use_proxy=0
use_proxy_auth=0

# service apt-cacher start|stop|restart

Au premier démarrage, un message d’erreur nous avertit simplement que les deux fichiers
journaux access.log et error.log ont été créés.

Pour vérifier le bon fonctionnement de Apt-Cacher, ouvrir dans un navigateur :
         http://ip_du_serveur:3142

         http://ip_du_serveur:3142/report

La première page affiche un résumé de la configuration, la seconde présente une synthèse de
l'efficacité du proxy.

' Configuration des postes clients '
Créer un fichier /etc/apt/apt.conf qui pointe vers le proxy :
# /etc/apt/apt.conf*
Acquire::http::Proxy "http://192.168.2.1:3142/";

Cette configuration pourrait être définie dans /etc/apt/apt.conf.d/01proxy au choix.


#-------------------------------------------------------------------------------------
' 8 - Installer le serveur DNS local et configurer dhcp '
#-------------------------------------------------------------------------------------

Pare-feu : ouvrir le port 53 en TCP et en UDP.
Installation
# aptitude install bind9 dnsutils
# /etc/bind/named.conf.options
options {
        directory "/var/cache/bind";

        // If there is a firewall between you and nameservers you want
        // to talk to, you may need to fix the firewall to allow multiple
        // ports to talk.  See http://www.kb.cert.org/vuls/id/800113

        // If your ISP provided one or more IP addresses for stable
        // nameservers, you probably want to use them as forwarders.
        // Uncomment the following block, and insert the addresses replacing
        // the all-0's placeholder.

        forwarders {
                212.27.40.240;
                212.27.40.241;
        };

        auth-nxdomain no;    # conform to RFC1035
        listen-on-v6 { any; };
};

# service bind9 restart

-------------------------

# /etc/resolv.conf
nameserver 127.0.0.1

Vérifier que le serveur écoute bien sur le port 53 en utilisant dig sur l’interface loopback :
# dig -x 127.0.0.1
---/---
;; Query time: 13 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Sun Aug 26 00:03:19 2012
;; MSG SIZE  rcvd: 121

Test 1 vers l'extérieur
# dig atelierlinux.regards.free.fr
---/---
;; Query time: 68 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Sun Aug 26 00:04:57 2012
;; MSG SIZE  rcvd: 88

Test 2 vers l'estérieur (même destination)
# dig atelierlinux.regards.free.fr
---/---
;; Query time: 0 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Sun Aug 26 00:06:35 2012
;; MSG SIZE  rcvd: 88

----------------------

# /etc/dhcp/dhcpd.conf
# Si on utilise les DNS de Free (ou d'un autre fournisseur d'accès)
#option domain-name-servers  212.27.40.240, 212.27.40.241;

# Si on utilise notre DNS local dans le serveur
option domain-name-servers  192.168.1.1;
# service isc-dhcp-server restart

----------------------

# cp /etc/bind/db.local /etc/bind/db.labo.arles
# /etc/bind/db.labo.arles

; db.labo.arles
$TTL 86400       ; (un jour)
$ORIGIN labo.arles.
@ IN SOA cerbere.labo.arles. hostmaster.labo.arles. (
   2012081801    ; sn
         10800   ; refresh (3 heures)
           600   ; retry (10 minutes)
       1814400   ; expiry (3 semaines)
         10800 ) ; minimum (3 heures)
            IN NS cerbere.labo.arles.
cerbere     IN A   192.168.1.1
prunelle    IN A   192.168.1.2
bart        IN A   192.168.1.3
asus        IN A   192.168.1.4

# service bind9 restart

------------------------

# /etc/bind/db.192.168.1
; db.192.168.1
$TTL 86400
$ORIGIN 1.168.192.IN_ADDR.ARPA.
@ IN SOA cerbere.labo.arles. hostmaster.labo.arles. (
   2012081802   ; sn
        10800   ; refresh (3 heures)
           600  ; retry (10 minutes)
      1814400   ; expiry (3 semaines)
        10800 ) ; minimum (3 heures)
    IN NS cerbere.labo.arles.
1   IN PTR cerbere.labo.arles.
2   IN PTR prunelle.labo.arles.
3   IN PTR bart.labo.arles.
4   IN PTR asus.labo.arles.

# service bind9 restart

Si problème de fonctionnement vérifier que les utilisateurs et les groupes des fichiers correspondent à cet exemple

-rw-r--r-- 1 root root 2,5K  1 avril 22:28 bind.keys
-rw-r--r-- 1 root root  237  1 avril 22:30 db.0
-rw-r--r-- 1 root root  271  1 avril 22:30 db.127
-rw-r--r-- 1 root bind  445  1 avril 22:57 db.192.168.2
-rw-r--r-- 1 root root  237  1 avril 22:30 db.255
-rw-r--r-- 1 root root  353  1 avril 22:30 db.empty
-rw-r--r-- 1 root bind  463  1 avril 22:56 db.labo2.arles
-rw-r--r-- 1 root root  270  1 avril 22:30 db.local
-rw-r--r-- 1 root root 3,0K  1 avril 22:30 db.root
-rw-r--r-- 1 root bind  463  1 avril 22:31 named.conf
-rw-r--r-- 1 root bind  490  1 avril 22:31 named.conf.default-zones
-rw-r--r-- 1 root bind  336  1 avril 22:48 named.conf.local
-rw-r--r-- 1 root bind  587  1 avril 22:31 named.conf.options
-rw-r----- 1 bind bind   77  1 avril 22:16 rndc.key
-rw-r--r-- 1 root root 1,3K  1 avril 22:31 zones.rfc1918

----------------------

#-------------------------------------------------------------------------------------
' 9 - Installer le cache squid '
#-------------------------------------------------------------------------------------

Ouvrir le port 3128 en TCP et en UDP
Pour utiliser Squid comme proxy transparent,
il faut rediriger les requêtes HTTP (port 80) vers le port 3128.
Il faudra faire une exception pour les requêtes HTTP à destination du serveur lui-même.


# aptitude install squid

# cd /etc/squid
# mv squid.conf squid.conf.orig
# grep -v ‘^#’ squid.conf.orig | cat -s > squid.conf

# /etc/squid/squid.conf
# Nom d'hôte du serveur Squid
visible_hostname cerbere.labo.arles

# Définitions
acl all src all
acl manager proto cache_object
acl localhost src 127.0.0.1/32
acl to_localhost dst 127.0.0.0/8 0.0.0.0/32

# Réseau local
acl localnet src 192.168.1.0/255.255.255.0
acl SSL_ports port 443     # https
acl SSL_ports port 563     # snews
acl SSL_ports port 873     # rsync
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 631         # cups
acl Safe_ports port 901         # SWAT
acl purge method PURGE
acl CONNECT method CONNECT

# Règles d'accès
http_access allow manager localhost
http_access deny manager
http_access allow purge localhost
http_access deny purge
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost
http_access allow localnet
http_access deny all
icp_access allow localnet
icp_access deny all

# Port du proxy
http_port 3128 transparent

# Taille du cache RAM
cache_mem 64 MB

# Emplacement et taille du cache sur le disque
cache_dir ufs /var/spool/squid/ 5000 16 256
# Désactiver les logs
access_log none

# Pas de cache si l'URL contient cgi-bin
hierarchy_stoplist cgi-bin ?

# Durée de vie de fichiers sans date d'expiration
refresh_pattern ^ftp:   1440 20% 10080
refresh_pattern ^gopher: 1440 0% 1440
refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
refresh_pattern (Release|Package(.gz)*)$ 0 20% 2880
refresh_pattern .   0 20% 4320

# Configurations diverses
acl shoutcast rep_header X-HTTP09-First-Line ^ICY.[0-9]
upgrade_http0.9 deny shoutcast
acl apache rep_header Server ^Apache
broken_vary_encoding allow apache
extension_methods REPORT MERGE MKACTIVITY CHECKOUT
hosts_file /etc/hosts
coredump_dir /var/spool/squid

#url_rewrite_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf
#url_rewrite_children 5

-------------------------

# service squid start|stop|reload|force-reload|restart|status

-------------------------

# sysv-rc-conf squid on|off


